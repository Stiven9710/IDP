# üîí Seguridad para URLs Externas - IDP Expert System

## üìã **RESUMEN EJECUTIVO**

**Problema:** Las URLs de documentos que vienen de Power Automate pueden representar **vulnerabilidades de seguridad** si no se validan adecuadamente.

**Soluci√≥n:** Sistema completo de **validaci√≥n de seguridad** con lista blanca de dominios, bloqueo de extensiones peligrosas y timeouts de seguridad.

---

## üö® **RIESGOS DE SEGURIDAD IDENTIFICADOS**

### **üî¥ Amenazas Principales:**

#### **1. URLs Maliciosas**
- **Phishing:** URLs que simulan sitios leg√≠timos
- **Malware:** Descarga de archivos ejecutables
- **Scam:** Sitios fraudulentos para robo de datos

#### **2. Acceso No Autorizado**
- **Archivos privados** de otras organizaciones
- **Informaci√≥n sensible** expuesta p√∫blicamente
- **Recursos internos** accesibles externamente

#### **3. Ataques T√©cnicos**
- **SSRF (Server-Side Request Forgery):** Forzar al servidor a acceder a recursos internos
- **DoS (Denial of Service):** Consumo excesivo de recursos
- **Data Exfiltration:** Extracci√≥n no autorizada de datos

---

## üõ°Ô∏è **SOLUCIONES IMPLEMENTADAS**

### **1. üîí Lista Blanca de Dominios**

#### **‚úÖ Dominios Permitidos (Microsoft/Azure):**
```
üåê Microsoft Office 365 / SharePoint:
   - sharepoint.com
   - onedrive.live.com
   - office.com
   - microsoft.com
   - outlook.com
   - live.com

‚òÅÔ∏è Azure Storage:
   - blob.core.windows.net
   - storage.azure.com
   - file.core.windows.net

üè¢ OneDrive Business:
   - sharepoint.com
   - office365.com

üîß Otros Servicios Microsoft:
   - teams.microsoft.com
   - portal.office.com
   - admin.microsoft.com
```

#### **üö´ Dominios Bloqueados (Lista Negra):**
```
üö® Dominios Maliciosos Conocidos:
   - malicious.com
   - phishing.net
   - scam.org
   - evil.com
   - hack.com
   - virus.com
   - malware.net

üé£ Dominios de Phishing:
   - phish.com
   - fake.com
   - spoof.net
   - trick.com
```

### **2. ‚ö†Ô∏è Bloqueo de Extensiones Peligrosas**

#### **üö´ Extensiones Bloqueadas:**
```
üíª Ejecutables:
   - exe, bat, cmd, com, pif

üìú Scripts:
   - ps1, vbs, js, jse, wsf, wsh

‚òï Java:
   - jar, class

üì¶ Instaladores:
   - msi, msu, msp

‚ö†Ô∏è Otros Peligrosos:
   - scr, hta, chm, hlp
```

### **3. ‚è±Ô∏è Timeouts y L√≠mites de Seguridad**

#### **üîí Configuraciones de Seguridad:**
```
‚è±Ô∏è Timeout de Descarga: 30 segundos
üìè Tama√±o M√°ximo de Archivo: 100 MB
üîÑ M√°ximo de Redirecciones: 5
üö¶ Rate Limiting: 60/min, 1000/h
```

---

## üèóÔ∏è **ARQUITECTURA DE SEGURIDAD**

### **üìä Flujo de Validaci√≥n:**

```
1. üì• Recibir URL del documento
   ‚Üì
2. üîç Validar formato de URL
   ‚Üì
3. üåê Extraer dominio
   ‚Üì
4. üö´ Verificar lista negra
   ‚Üì
5. ‚úÖ Verificar lista blanca
   ‚Üì
6. üè† Verificar URLs locales/privadas
   ‚Üì
7. üìè Validar tama√±o del archivo
   ‚Üì
8. ‚ö†Ô∏è Verificar extensi√≥n del archivo
   ‚Üì
9. ‚úÖ Procesar documento seguro
```

### **üîß Componentes de Seguridad:**

#### **1. SecurityConfig (`app/core/security_config.py`)**
- **Configuraci√≥n centralizada** de seguridad
- **Validadores Pydantic** para configuraci√≥n
- **M√©todos de validaci√≥n** reutilizables

#### **2. DocumentService (`app/services/document_service.py`)**
- **Integraci√≥n** de validaciones de seguridad
- **Logging detallado** de eventos de seguridad
- **Manejo de errores** de seguridad

---

## üìù **IMPLEMENTACI√ìN T√âCNICA**

### **üîí Configuraci√≥n de Seguridad:**

```python
# app/core/security_config.py
class SecurityConfig(BaseSettings):
    # Dominios permitidos (lista blanca)
    ALLOWED_DOMAINS: List[str] = [
        'sharepoint.com',
        'onedrive.live.com',
        'blob.core.windows.net',
        # ... m√°s dominios
    ]
    
    # Dominios bloqueados (lista negra)
    BLOCKED_DOMAINS: List[str] = [
        'malicious.com',
        'phishing.net',
        # ... m√°s dominios
    ]
    
    # Extensiones peligrosas
    DANGEROUS_EXTENSIONS: List[str] = [
        'exe', 'bat', 'cmd', 'ps1', 'vbs'
        # ... m√°s extensiones
    ]
    
    # Configuraciones de seguridad
    DOWNLOAD_TIMEOUT_SECONDS: int = 30
    MAX_FILE_SIZE_MB: int = 100
    MAX_REDIRECTS: int = 5
```

### **üõ°Ô∏è Validaci√≥n de URLs:**

```python
# app/services/document_service.py
async def validate_external_url(self, url: str) -> Dict[str, Any]:
    """
    Valida que la URL externa sea segura para procesar
    """
    try:
        # Verificar que sea una URL v√°lida
        parsed_url = urlparse(url)
        if not parsed_url.scheme or not parsed_url.netloc:
            return {'is_valid': False, 'reason': 'URL inv√°lida'}
        
        # Verificar que sea HTTPS
        if parsed_url.scheme.lower() != 'https':
            return {'is_valid': False, 'reason': 'Protocolo no seguro'}
        
        # Extraer dominio
        domain = parsed_url.netloc.lower()
        
        # Verificar dominios permitidos/bloqueados
        if not self.security_config.is_domain_allowed(domain):
            return {'is_valid': False, 'reason': 'Dominio no permitido'}
        
        # Verificar URLs locales/privadas
        if any(private_ip in domain for private_ip in ['localhost', '127.0.0.1']):
            return {'is_valid': False, 'reason': 'URL local/privada'}
        
        return {'is_valid': True, 'reason': 'URL segura'}
        
    except Exception as e:
        return {'is_valid': False, 'reason': f'Error de validaci√≥n: {str(e)}'}
```

### **üîç Validaci√≥n de Documentos:**

```python
async def validate_document_security(self, url: str, file_size_mb: float) -> Dict[str, Any]:
    """
    Valida la seguridad del documento antes del procesamiento
    """
    # Validar URL
    url_validation = await self.validate_external_url(url)
    if not url_validation['is_valid']:
        return url_validation
    
    # Validar tama√±o del archivo
    if file_size_mb > self.security_config.MAX_FILE_SIZE_MB:
        return {
            'is_valid': False,
            'reason': 'Archivo demasiado grande'
        }
    
    # Validar extensi√≥n del archivo
    file_extension = url.lower().split('.')[-1] if '.' in url else ''
    if self.security_config.is_extension_dangerous(file_extension):
        return {
            'is_valid': False,
            'reason': 'Extensi√≥n peligrosa'
        }
    
    return {'is_valid': True, 'reason': 'Documento seguro'}
```

---

## üöÄ **INTEGRACI√ìN EN EL FLUJO PRINCIPAL**

### **üì• Procesamiento de Documentos:**

```python
async def process_document(self, request: DocumentProcessingRequest):
    """
    Procesar un documento con validaciones de seguridad
    """
    try:
        # üîí VALIDACI√ìN DE SEGURIDAD PARA URLs EXTERNAS
        logger.info("üîí INICIANDO VALIDACIONES DE SEGURIDAD")
        
        # Validar formato del documento
        if not self._validate_document_format(str(request.document_path)):
            raise ValueError("Formato de documento no soportado")
        
        # Obtener tama√±o del archivo
        file_size_mb = await self._get_document_size(str(request.document_path))
        
        # Validar seguridad del documento (URL + tama√±o + extensi√≥n)
        security_validation = await self.validate_document_security(
            str(request.document_path), 
            file_size_mb
        )
        
        if not security_validation['is_valid']:
            logger.error(f"üö´ VALIDACI√ìN DE SEGURIDAD FALLIDA: {security_validation['reason']}")
            raise ValueError(f"Documento rechazado por seguridad: {security_validation['reason']}")
        
        logger.info(f"‚úÖ VALIDACI√ìN DE SEGURIDAD EXITOSA")
        
        # Continuar con el procesamiento...
        
    except Exception as e:
        logger.error(f"‚ùå Error en el procesamiento: {str(e)}")
        raise
```

---

## üìä **LOGGING Y MONITOREO DE SEGURIDAD**

### **üîç Eventos Registrados:**

#### **‚úÖ Accesos Permitidos:**
```
üîí Validando seguridad de URL: https://company.sharepoint.com/document.pdf
üåê Dominio extra√≠do: company.sharepoint.com
‚úÖ Dominio permitido: company.sharepoint.com
‚úÖ URL validada exitosamente
‚úÖ Documento validado como seguro
```

#### **üö´ Accesos Bloqueados:**
```
üîí Validando seguridad de URL: https://malicious.com/file.exe
üåê Dominio extra√≠do: malicious.com
üö´ Dominio bloqueado o no permitido: malicious.com
üö´ VALIDACI√ìN DE SEGURIDAD FALLIDA: Dominio no permitido
```

### **üìà M√©tricas de Seguridad:**

```python
def get_security_summary(self) -> Dict[str, Any]:
    """
    Obtener resumen de la configuraci√≥n de seguridad
    """
    return {
        'allowed_domains_count': len(self.ALLOWED_DOMAINS),
        'blocked_domains_count': len(self.BLOCKED_DOMAINS),
        'dangerous_extensions_count': len(self.DANGEROUS_EXTENSIONS),
        'download_timeout': f"{self.DOWNLOAD_TIMEOUT_SECONDS}s",
        'max_file_size': f"{self.MAX_FILE_SIZE_MB} MB",
        'max_redirects': self.MAX_REDIRECTS,
        'rate_limiting': {
            'per_minute': self.MAX_REQUESTS_PER_MINUTE,
            'per_hour': self.MAX_REQUESTS_PER_HOUR
        }
    }
```

---

## ‚öôÔ∏è **CONFIGURACI√ìN Y PERSONALIZACI√ìN**

### **üîß Variables de Entorno:**

```bash
# .env
# Dominios permitidos (separados por comas)
ALLOWED_DOMAINS=sharepoint.com,onedrive.live.com,blob.core.windows.net

# Dominios bloqueados (separados por comas)
BLOCKED_DOMAINS=malicious.com,phishing.net,scam.org

# Extensiones peligrosas (separadas por comas)
DANGEROUS_EXTENSIONS=exe,bat,cmd,ps1,vbs,js

# Configuraciones de seguridad
DOWNLOAD_TIMEOUT_SECONDS=30
MAX_FILE_SIZE_MB=100
MAX_REDIRECTS=5
MAX_REQUESTS_PER_MINUTE=60
MAX_REQUESTS_PER_HOUR=1000
```

### **üìã Personalizaci√≥n de Dominios:**

#### **Para Organizaciones Espec√≠ficas:**
```python
# Agregar dominios corporativos
ALLOWED_DOMAINS = [
    'sharepoint.com',
    'onedrive.live.com',
    'company.com',           # Dominio corporativo
    'internal.company.com',  # Subdominio interno
    'docs.company.com'       # Servidor de documentos
]
```

#### **Para Entornos de Desarrollo:**
```python
# Permitir URLs locales en desarrollo
ALLOW_LOCAL_URLS = True
ALLOW_PRIVATE_IPS = True
ALLOW_HTTP = True  # Solo en desarrollo
```

---

## üß™ **PRUEBAS DE SEGURIDAD**

### **‚úÖ Casos de Prueba Positivos:**

#### **1. URLs V√°lidas de Microsoft:**
```
‚úÖ https://company.sharepoint.com/document.pdf
‚úÖ https://onedrive.live.com/file.docx
‚úÖ https://storage.blob.core.windows.net/container/file.pptx
```

#### **2. Archivos Seguros:**
```
‚úÖ Documentos: PDF, DOCX, PPTX, XLSX
‚úÖ Im√°genes: JPG, PNG, GIF, BMP
‚úÖ Texto: TXT, RTF, MD
```

### **‚ùå Casos de Prueba Negativos:**

#### **1. URLs Maliciosas:**
```
‚ùå https://malicious.com/file.exe
‚ùå https://phishing.net/document.pdf
‚ùå http://evil.com/file.bat
```

#### **2. Archivos Peligrosos:**
```
‚ùå https://sharepoint.com/file.exe
‚ùå https://onedrive.com/script.ps1
‚ùå https://microsoft.com/virus.bat
```

#### **3. URLs Locales/Privadas:**
```
‚ùå http://localhost/document.pdf
‚ùå https://192.168.1.100/file.docx
‚ùå https://10.0.0.1/document.pptx
```

---

## üö® **RESPUESTA A INCIDENTES**

### **üîç Detecci√≥n de Amenazas:**

#### **1. URLs Bloqueadas:**
```
üö´ Dominio bloqueado detectado: malicious.com
üö´ VALIDACI√ìN DE SEGURIDAD FALLIDA: Dominio no permitido
üìã Detalles: El dominio malicious.com no est√° en la lista blanca o est√° bloqueado
```

#### **2. Archivos Peligrosos:**
```
üö´ Extensi√≥n peligrosa detectada: exe
üö´ VALIDACI√ìN DE SEGURIDAD FALLIDA: Extensi√≥n peligrosa
üìã Detalles: No se permiten archivos con extensi√≥n exe
```

#### **3. Archivos Demasiado Grandes:**
```
‚ö†Ô∏è Archivo demasiado grande: 150.00 MB > 100 MB
üö´ VALIDACI√ìN DE SEGURIDAD FALLIDA: Archivo demasiado grande
üìã Detalles: El archivo excede el tama√±o m√°ximo permitido: 150.00 MB > 100 MB
```

### **üìä Acciones de Respuesta:**

#### **1. Bloqueo Inmediato:**
- **Rechazar** el documento
- **Registrar** el intento de acceso
- **Notificar** al equipo de seguridad

#### **2. Logging Detallado:**
- **Timestamp** del intento
- **URL** del documento
- **IP** de origen
- **Usuario** que realiz√≥ la petici√≥n

#### **3. An√°lisis Post-Incidente:**
- **Revisar** logs de seguridad
- **Identificar** patrones de ataque
- **Actualizar** listas de dominios

---

## üîÑ **MANTENIMIENTO Y ACTUALIZACIONES**

### **üìÖ Tareas Peri√≥dicas:**

#### **1. Revisi√≥n Mensual:**
- **Actualizar** lista de dominios bloqueados
- **Revisar** logs de seguridad
- **Analizar** intentos de acceso bloqueados

#### **2. Revisi√≥n Trimestral:**
- **Evaluar** dominios permitidos
- **Revisar** extensiones peligrosas
- **Actualizar** configuraciones de timeout

#### **3. Revisi√≥n Anual:**
- **Auditor√≠a** completa de seguridad
- **Revisi√≥n** de pol√≠ticas de acceso
- **Actualizaci√≥n** de procedimientos

### **üîß Actualizaci√≥n de Configuraci√≥n:**

```python
# Agregar nuevo dominio malicioso
BLOCKED_DOMAINS.append('new-malicious.com')

# Agregar nueva extensi√≥n peligrosa
DANGEROUS_EXTENSIONS.append('new-dangerous')

# Actualizar timeout de descarga
DOWNLOAD_TIMEOUT_SECONDS = 45

# Aplicar cambios
security_config = SecurityConfig()
```

---

## üìö **MEJORES PR√ÅCTICAS**

### **üõ°Ô∏è Recomendaciones de Seguridad:**

#### **1. Lista Blanca Estricta:**
- **Solo permitir** dominios conocidos y confiables
- **Revisar regularmente** la lista de dominios permitidos
- **Documentar** el prop√≥sito de cada dominio

#### **2. Monitoreo Continuo:**
- **Revisar logs** de seguridad diariamente
- **Configurar alertas** para intentos bloqueados
- **Analizar patrones** de acceso sospechoso

#### **3. Actualizaci√≥n Regular:**
- **Mantener actualizadas** las listas de dominios
- **Revisar** nuevas amenazas de seguridad
- **Actualizar** configuraciones seg√∫n sea necesario

### **üö´ Lo que NO hacer:**

#### **1. Permitir URLs HTTP:**
```
‚ùå http://sharepoint.com/document.pdf
‚úÖ https://sharepoint.com/document.pdf
```

#### **2. Permitir Dominios Desconocidos:**
```
‚ùå https://unknown-domain.com/file.pdf
‚úÖ https://sharepoint.com/file.pdf
```

#### **3. Ignorar Extensiones Peligrosas:**
```
‚ùå Procesar archivos .exe, .bat, .ps1
‚úÖ Solo procesar documentos seguros
```

---

## üéØ **CONCLUSIONES**

### **üí™ Beneficios de la Implementaci√≥n:**

1. **üîí Seguridad Garantizada:** Solo URLs de dominios confiables
2. **üö´ Bloqueo Proactivo:** Prevenci√≥n de amenazas conocidas
3. **üìä Monitoreo Completo:** Logging detallado de eventos de seguridad
4. **‚öôÔ∏è Configuraci√≥n Flexible:** F√°cil personalizaci√≥n seg√∫n necesidades
5. **üîÑ Mantenimiento Sencillo:** Actualizaci√≥n centralizada de configuraciones

### **üöÄ Recomendaciones Finales:**

1. **Implementar** todas las validaciones de seguridad
2. **Configurar** listas de dominios seg√∫n la organizaci√≥n
3. **Monitorear** continuamente los logs de seguridad
4. **Actualizar** regularmente las configuraciones
5. **Documentar** todos los cambios de seguridad

---

## üìû **SOPORTE Y CONTACTO**

### **üÜò Problemas Comunes:**

- **URL bloqueada:** Verificar lista de dominios permitidos
- **Archivo rechazado:** Verificar extensi√≥n y tama√±o
- **Timeout de descarga:** Ajustar configuraci√≥n de timeout

### **üìß Contacto:**

- **Equipo de Desarrollo:** IDP Expert System
- **Repositorio:** [GitHub IDP](https://github.com/Stiven9710/IDP)
- **Documentaci√≥n:** Carpeta `docs/`

---

**üìÖ √öltima Actualizaci√≥n:** $(date +"%d/%m/%Y")  
**üîß Versi√≥n del Documento:** 1.0  
**üë®‚Äçüíª Mantenido por:** Equipo IDP Expert System  

---

*"La seguridad no es un producto, es un proceso continuo de protecci√≥n y mejora."* üõ°Ô∏è‚ú®
